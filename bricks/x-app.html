<template page>
  <header>
    <h1 id=logo>
      <img src=https://assets.tci.anthropedia.org/images/anthropedia.svg alt="Anthropedia Foundation">
    </h1>
    <section id=language>
      <button value=en on:click="this.switchLanguage"><img alt=English title=English src=https://upload.wikimedia.org/wikipedia/commons/a/a4/Flag_of_the_United_States.svg></button>
      <button value=se on:click="this.switchLanguage"><img alt=Swedish title=Swedish src=https://upload.wikimedia.org/wikipedia/commons/4/4c/Flag_of_Sweden.svg></button>
    </section>
  </header>

  <main>
    <x-introduction :if="this.page === 'introduction'" key="${ this.key }"></x-introduction>
    <x-test :if="this.page === 'test'" key="${ this.key }" questions="${ this.questions }"></x-test>
    <x-end :if="this.page === 'end'"></x-end>
    <error-404 :if="this.page === 'error'" error="${ this.error }"></error-404>
    <p
  </main>

  <footer>
    ${ _('ANTHROPEDIA™ FOUNDATION is a U.S. registered 501(c)(3) tax-deductible nonprofit charity<br>©2019 ANTHROPEDIA™ FOUNDATION all rights reserved.') }
  </footer>
</template>

<script>
  this.setState({
    page: '',
    clients: [],
    clientId: null,
    user: {},
    questions: [],
  })

  page('*', (req, next) => {
    document.body.onbeforeunload = null
    next()
  })

  page('/end', () => this.render({ page: 'end' }))

  page('/:key/test', async (req) => {
    this.state.key = req.params.key
    const response = await api(`/assignment/${this.state.key}/questions`)
    if (!response.ok) return this.render({ page: 'error', error: "The link is invalid or outdated" })
    this.render({ questions: response.data, page: 'test' })
    document.body.onbeforeunload = () => confirm('You are in the middle of the test and you will have to start over. Are you sure you want to quit?')
  })

  page('/:key', async (req) => {
    this.state.key = req.params.key
    const response = await api(`/assignment/${this.state.key}/questions` )
    if (!response.ok) return this.render({ page: 'error', error: "The link is invalid or outdated" })
    this.render({ page: 'introduction' })
  })

  page('*', () => this.render({ page: 'error' }))

  init(() => {
    page({ hashbang: true })
  })

  this.switchLanguage = (event) => {
    localStorage.language = event.currentTarget.value
    window.location.reload()
  }
</script>

<style>
  header {
    padding: .1rem 1rem;
    background-color: var(--white-background);
    box-shadow: .3rem 0 .5rem rgba(0, 0, 0, .4);
    position: sticky;
    top: 0;
    z-index: 3;
  }
  #logo {
    width: 5rem;
  }
  #logo a,
  #logo img {
    display: inline-block;
    width: 100%;
  }

  footer {
    color: white;
    padding: 1rem;
    font-size: .6rem;
  }

  header {
    display: flex;
  }
  #language {
    flex: 1;
    align-self: center;
    text-align: right;
  }
  #language button {
    max-width: 2rem;
    border: 0;
    background: none;
    cursor: pointer;
  }
  #language img {
    width: 100%;
  }
</style>
